#!/usr/bin/env awk-f

function snip(key, value) {
  if (value == "") {
    print "missing value for key:", key > "/dev/stderr"
    exit 1
  }
  if (snippets[key]) {
    print "duplicate key:", key > "/dev/stderr"
    exit 1
  }
  snippets[key] = value
}

# current max: 4
function cycle(key, v1, v2, v3, v4) {
  delete parts
  if (v1 != "") parts[1] = v1
  if (v2 != "") parts[2] = v2
  if (v3 != "") parts[3] = v3
  if (v4 != "") parts[4] = v4
  len = length(parts)
  parts[len+1] = parts[1]
  for (i = 1; i <= len; i++) {
    snip(key ":" parts[i], parts[i+1])
  }
}

BEGIN {
  # prefixes
  split(filetype, pre, ".")
  pre[length(pre)+1] = "*"

  #-------------------------------------------------
  # global
  #-------------------------------------------------
  snip("*:--",   "-------------------------------------------------")
  snip("*:isod", strftime("%F"))
  snip("*:dn",   strftime("%A"))
  snip("*:td",   strftime("%F -- %A"))
  snip("*:ts",   strftime("%s"))
  snip("*:?",    "â“")
  snip("*:O",    "ðŸ”†")
  cycle("*",     "_", "ðŸ“¦", "âœ…")
  snip("*:x",    "âŒ")
  snip("*:!",    "âš ï¸")
  snip("*:<3",   "â¤ï¸")
  snip("*:cr",   "âŽ")
  snip("*:->",   "â†’")
  snip("*:=>",   "â‡¨")
  snip("*:<->",  "â‡†")
  snip("*:+-",   "Â±")
  cycle("*",     "*", "Ã—", "â‹…")
  snip("*:/",    "Ã·")
  snip("*:>=",   "â‰¥")
  snip("*:<=",   "â‰¤")
  snip("*:cmd",  "âŒ˜")
  snip("*:alt",  "âŒ¥")

  # spanish accents
  snip("*:a'", "Ã¡")
  snip("*:i'", "Ã­")
  snip("*:u'", "Ãº")
  snip("*:u:", "Ã¼")
  snip("*:e'", "Ã©")
  snip("*:o'", "Ã³")
  snip("*:n~", "Ã±")

  # emojis
  snip("*::think",  "ðŸ¤”")

  #-------------------------------------------------
  # javascript
  #-------------------------------------------------
  snip("javascript:fn",   "function â–’() {\n}")
  snip("javascript:fori", "for (let i = 0; i < â–’; i += 1) {")
  snip("javascript:fe",   "forEach(â–’)")
  snip("javascript:iife", "(() => {\nâ–’\n})();")

  #-------------------------------------------------
  # r and rmd
  #-------------------------------------------------
  snip("r:fn", "function")
  snip("r:|",  "%>%")
  snip("r:>",  "%>%")
  snip("r:_",  ".Last.value");
  snip("r:#h", "#-------------------------------------------------\n# â–’name\n#-------------------------------------------------");
  for (k in snippets) {
    if (k !~ /^r:/) { continue }
    v = snippets[k]
    sub("r:", "rmd:", k)
    snippets[k] = v
  }
  snip("rmd:```",  "```{r}\n\nâ–’\n\n```");

  #-------------------------------------------------
  # go
  #-------------------------------------------------
  snip("go:fn",      "func â–’() {\n}")
  snip("go:fori",    "for i := 0; i < â–’; i++ {}")
  snip("go:forr",    "for i, _ := range â–’ {}")
  snip("go:iferr",   "if err != nil { return err }")
  snip("go:handler", "func(res http.ResponseWriter, req *http.Request)")
  cycle("go",        "fmt.", "fmt.Println", "fmt.Printf")

  #-------------------------------------------------
  # elixir
  #-------------------------------------------------
  snip("elixir:defm",  "defmodule")
  snip("elixir:tap",   "IO.inspect()")
  snip("elixir:tapl",  "IO.inspect(label: \"â–’\")")
  snip("elixir::clal", "charlists: :as_lists")
  snip("elixir:pry",   "require IEx; IEx.pry()")
  #-------------------------------------------------
  # eex
  #-------------------------------------------------
  snip("eelixir:_", "<%= â–’ %>")
  cycle("eelixir",  "<%= ", "<%# ", "<% ")

  #-------------------------------------------------
  # elm
  #-------------------------------------------------
  snip("elm:letin", "let _ = â–’ in")
  snip("elm:log",   "Debug.log \"label\"")
  snip("elm:if",    "if â–’ then True else False")

  #-------------------------------------------------
  # sql
  #-------------------------------------------------
  snip("sql:ea", "EXPLAIN ANALYZE")
}

#-------------------------------------------------

# try to match from the right
# try ft-specific first, global next
# try to find longest match
{
  _i = -1
  _text = ""
  for (i = length($0); i > 0; i--) {
    ss = substr($0, i)
    for (j = 1; j <= length(pre); j++) {
      text = snippets[pre[j] ":" ss]
      if (text) {
        _i = i
        _text = text
        break
      }
    }
  }
  if (_text) {
      print substr($0, 1, _i-1) _text
      next
  }
}

# no match, print as-is
{
  print
}
