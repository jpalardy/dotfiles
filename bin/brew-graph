#!/bin/bash

remove_casks() {
  awk -F'"' 'ARGIND == 1 {lut[$0]; next} !($2 in lut) {print}' <(brew list --cask) -
}

format="png"

while getopts "T:" opt; do
  case "$opt" in
    T)
      format=$OPTARG
      ;;
    *)
      echo >&2 "Usage: brew-graph [-T format]"
      exit 1
  esac
done

cmd="brew-graph.rb --installed --highlight-leaves | remove_casks"

if command -v neato >/dev/null; then
  cmd="$cmd | neato -T $format -o brew-deps.$format"
fi

eval "$cmd"

