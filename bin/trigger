#!/bin/bash

set -o nounset  # -u
set -o errexit  # -e
set -o pipefail # ...

#-------------------------------------------------

usage() {
  cat >&2 <<EOM
Usage: $(basename "$0") [OPTION]... -c "command to run" [FILES-TO-WATCH]

  -c          command to run
  -h          display help
EOM
  exit 1
}

#-------------------------------------------------

COMMAND="make"

while getopts "c:h" opt; do
  case "$opt" in
    c)
      COMMAND=$OPTARG
      ;;
    h|*)
      usage
      ;;
  esac
done

shift $((OPTIND - 1))

#-------------------------------------------------

notify() {
  lastexit=$1
  if ! command -v afplay &>/dev/null; then
    return
  fi
  if [ "$lastexit" -ne 0 ]; then
    afplay "/System/Library/Sounds/Basso.aiff"
    return
  fi
  afplay "/System/Library/Sounds/Purr.aiff"
}
export -f notify

fswatch "$@" -o | xargs -I% sh -c "$COMMAND; notify \$?"

