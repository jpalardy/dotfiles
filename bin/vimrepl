#!/bin/bash

die() {
  echo >&2 "$1"
  exit 1
}

if [ -z "$TMUX" ]; then
  die "need to run inside tmux"
fi

if [ "$(tmux list-panes -F'#{window_panes}' | head -n1)" -gt 1 ]; then
  die "window is already split"
fi

#-------------------------------------------------

filename=""

while getopts "f:" opt; do
  case "$opt" in
    f)
      filename=$OPTARG
      ;;
    *)
      die "unrecognized flag: $opt"
      ;;
  esac
done

shift $((OPTIND - 1))

if test -n "$filename"; then
  context=${filename##*.}
else
  context="$1"
  filename="_vimrepl.$1"
fi

# bit of a workaround: contexts don't have periods `.`
if [[ "$context" == *.* ]]; then
  filename="$context"
  context=${filename##*.}
fi

#-------------------------------------------------

if [ -z "$context" ]; then
  die "missing context"
fi

case "$context" in
  iex)
    cmd="iex"
    filename="${filename:-_vimrepl.exs}"
    ;;
  mix)
    cmd="iex -S mix"
    filename="${filename:-_vimrepl.exs}"
    ;;
  r|R|Rmd)
    cmd="R --quiet --no-save --no-restore"
    ;;
  *)
    cmd="$SHELL"
    ;;
esac

#-------------------------------------------------

# run "cmd", or shell in split pane
# launch shell if exit != 0
tmux split-window -h "$cmd || $SHELL"

# go back to initiating (last) pane
tmux select-pane -l

# vim...
vim "$filename"

# kill other pane(s)
tmux kill-pane -a

