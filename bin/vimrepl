#!/bin/bash

die() {
  echo >&2 "$1"
  exit 1
}

if [ -z "$TMUX" ]; then
  die "need to run inside tmux"
fi

if [ "$(tmux list-panes -F'#{window_panes}' | head -n1)" -gt 1 ]; then
  die "window is already split"
fi

if test "$#" -eq 0; then
  die "usage: vimrepl ext [-c command] [-f filename.ext]"
fi

#-------------------------------------------------

cmd="$SHELL"
filename="_vimrepl.$1"
shift

while getopts "c:f:" opt; do
  case "$opt" in
    c)
      cmd=$OPTARG
      ;;
    f)
      filename=$OPTARG
      ;;
    *)
      die "unrecognized flag"
      ;;
  esac
done

shift $((OPTIND - 1))

if test "$#" -gt 0; then
  die "extra arguments: $*"
fi

#-------------------------------------------------

# run "cmd", or shell in split pane
# launch shell if exit != 0
tmux split-window -h "$cmd || $SHELL"

# go back to initiating (last) pane
tmux select-pane -l

# vim...
vim "$filename"

# kill other pane(s)
tmux kill-pane -a

