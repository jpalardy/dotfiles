#!/bin/bash

die() {
  echo >&2 "$1"
  exit 1
}

if [ -z "$TMUX" ]; then
  die "need to run inside tmux"
fi

if [ "$(tmux list-panes -F'#{window_panes}' | head -n1)" -gt 1 ]; then
  die "window is already split"
fi

#-------------------------------------------------

cmd=""
filename=""
template=""
dryrun=0

while getopts "c:f:nt:" opt; do
  case "$opt" in
    c)
      cmd=$OPTARG
      ;;
    f)
      filename=$OPTARG
      ;;
    n)
      dryrun=1
      ;;
    t)
      template=$OPTARG
      ;;
    *)
      die "unrecognized flag"
      ;;
  esac
done

shift $((OPTIND - 1))

# no filename, assume extension
if test "$#" -gt 0 -a -z "$filename"; then
  filename="_vimrepl.$1"
  shift
fi

if test "$#" -gt 0; then
  die "extra arguments: $*"
fi

#-------------------------------------------------

if test -n "$template"; then
  case "$template" in
    iex)
      cmd="${cmd:-"iex"}"
      filename="${filename:-"_vimrepl.exs"}"
      ;;
    mix)
      cmd="${cmd:-"iex -S mix"}"
      filename="${filename:-"_vimrepl.exs"}"
      ;;
    phx)
      cmd="${cmd:-"iex -S mix phx.server"}"
      filename="${filename:-"_vimrepl.exs"}"
      ;;
    r|R|Rmd)
      cmd="${cmd:-"R --quiet --no-save --no-restore"}"
      filename="${filename:-"_vimrepl.$template"}"
      ;;
    elm)
      cmd="${cmd:-"elm repl"}"
      filename="${filename:-"_vimrepl.$template"}"
      ;;
    *)
      die "unrecognized template: $template"
      ;;
  esac
fi

if test -z "$cmd"; then
  cmd="$SHELL"
fi

if test -z "$filename"; then
  die "missing filename"
fi

#-------------------------------------------------

if test "$dryrun" == 1; then
  echo "cmd: $cmd"
  echo "filename: $filename"
  exit
fi

# run "cmd", or shell in split pane
# launch shell if exit != 0
tmux split-window -h "$cmd || $SHELL"

# go back to initiating (last) pane
tmux select-pane -l

# vim...
vim "$filename"

# kill other pane(s)
tmux kill-pane -a

